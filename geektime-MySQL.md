# MySQL 实战 45 讲

## 01 基础架构

MySQL 架构分为了两层：Server 层和存储引擎层

Server 层分为四个部分：

- 连接器：管理连接，权限验证
- 分析器：词法分析，语法分析
- 优化器：生成执行计划，索引选择
- 执行器：操作存储引擎，返回结果

<img src="https://i.loli.net/2021/02/03/G3TwfXOKExpLHjo.png" alt="MySQL 逻辑架构图" style="zoom: 25%;" />

### 连接器

在用户名和密码验证通过以后，连接器会去用户权限表查询用户拥有的权限。只有，这个连接里面用户所有的逻辑，都会依赖此时读取到的用户权限。

连接完成后，如果没有后续操作的话，连接会处于空闲状态，使用`show processlist`可以查看所有连接信息，`sleep`就是空闲状态的连接。

客户端如果太长时间没有操作，连接器会自动断开，默认是 8 小时，使用`wait_timeout`参数控制。

数据库连接分为长连接和短连接。通常建立连接过程比较复杂，建议使用长连接。长连接在连接成功后，如果客户端持续有请求，会使用同一个连接。短连接在每次执行完很少的几次查询后，就断开连接。

全部使用长连接存在问题，MysQL 在执行过程中临时使用的内存是保存在连接对象里面，这些资源只有在连接断开的时候才会释放，所以长连接累积下来会占用较多内存，导致 OOM 被系统杀掉进程，从现象看就是 MySQL 异常重启。

如何解决？1.定期断开长连接；2.如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

### 查询缓存

MySQL8 已经删除了此功能

### 分析器

`select * from T where ID = 1;`

对于这样一条 sql 语句，会先执行词法分析，然后执行语法分析。

词法分析器需要识别每个字符串分别是什么，代表什么。例如：从 select 这个关键字识别出这是一条查询语句，把字符串 T 识别为表名 T，把字符串 ID 识别为列 ID。

根据词法分析的结果，语法分析器会根据语法规则，判断 sql 语句师傅满足 MySQL 语法。

### 优化器

优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。比如你执行下面这样的语句，这个语句是执行两个表的 join：

```sql
mysql> select * from t1 join t2 using(ID) where t1.c=10 and t2.d=20;
```

- 既可以先从表 t1 里面取出 c=10 的记录的 ID 值，再根据 ID 值关联到表 t2，再判断 t2 里面 d 的值是否等于 20。
- 也可以先从表 t2 里面取出 d=20 的记录的 ID 值，再根据 ID 值关联到 t1，再判断 t1 里面 c 的值是否等于 10。

这两种执行方法的逻辑结果是一样的，但是执行的效率会有不同，而优化器的作用就是决定选择使用哪一个方案。

### 执行器

执行器执行之前，先要判断是否有操作当前表的权限。

如果有权限，打开表继续执行。

执行过程是借助于存储引擎提供的接口实现的：调用引擎接口遍历每一行是否满足查询条件，并组成结果集返回。
